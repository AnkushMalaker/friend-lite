services:
  # FastAPI Speaker Recognition Service
  speaker-service:
    build:
      context: .
      dockerfile: Dockerfile
    image: speaker-recognition:latest
    env_file:
      - .env
    ports:
      - "${SPEAKER_SERVICE_PORT:-8085}:${SPEAKER_SERVICE_PORT:-8085}"
    volumes:
      # Mount source code for development (live reload)
      - ./src:/app/src
      # Persist Hugging Face cache (models) between restarts
      - ./model_cache:/models
      - ./audio_chunks:/app/audio_chunks
      - ./debug:/app/debug
      # Persist speaker database (faiss.index + speakers.json)
      - ./speaker_data:/app/data
    # deploy:
    #       resources:
    #         reservations:
    #           devices:
    #             - driver: nvidia
    #               count: all
    #               capabilities: [gpu]
    environment:
      - HF_HOME=/models
      - HF_TOKEN=${HF_TOKEN}
      - SIMILARITY_THRESHOLD=${SIMILARITY_THRESHOLD:-0.15}
      - SPEAKER_SERVICE_HOST=${SPEAKER_SERVICE_HOST:-0.0.0.0}
      - SPEAKER_SERVICE_PORT=${SPEAKER_SERVICE_PORT:-8085}
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://speaker-service:8085/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # GPU Profile Configuration
  speaker-service-gpu:
    <<: *base-speaker-service
    profiles: ["gpu"]
    networks:
      default:
        aliases:
          - speaker-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        CUDA_VERSION: ${CUDA_VERSION:-cu121}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  
  # React Web UI
  web-ui:
    build:
      context: webui
      dockerfile: Dockerfile
    ports:
      - "${REACT_UI_PORT}:${REACT_UI_PORT}"
    volumes:
      # Mount source code for development (live reload)
      - ./webui/src:/app/src
      - ./webui/public:/app/public
      - ./webui/package.json:/app/package.json
      - ./webui/vite.config.ts:/app/vite.config.ts
      - ./webui/tailwind.config.js:/app/tailwind.config.js
      - ./webui/postcss.config.js:/app/postcss.config.js
      - ./webui/tsconfig.json:/app/tsconfig.json
    environment:
      - REACT_UI_HOST=${REACT_UI_HOST}
      - REACT_UI_PORT=${REACT_UI_PORT}
      - REACT_UI_HTTPS=${REACT_UI_HTTPS}
      - SPEAKER_SERVICE_HOST=${SPEAKER_SERVICE_HOST}
      - SPEAKER_SERVICE_PORT=${SPEAKER_SERVICE_PORT}
    depends_on:
      - speaker-service
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:${REACT_UI_PORT}"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx reverse proxy for unified HTTPS endpoint
  nginx:
    image: nginx:alpine
    ports:
      - "8444:443"
      - "8081:80"  
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - speaker-service
      - web-ui
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
