FROM python:3.10-bookworm

## Install system dependencies including PortAudio for pyaudio
RUN apt-get update && apt-get install -y \
build-essential \
git \
ffmpeg \
curl \
&& rm -rf /var/lib/apt/lists/*
# portaudio19-dev \
# libasound2-dev \

WORKDIR /app

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Copy dependency files first (for better caching)
# Copy dependency files first (for better caching)
COPY pyproject.toml uv.lock ./

# Copy source code
COPY src/ src/

# Install dependencies
ARG COMPUTE_MODE=gpu
RUN uv pip install --system setuptools wheel && \
if [ "$COMPUTE_MODE" = "gpu" ]; then \
    uv pip install --system --group gpu .; \
else \
    uv pip install --system --group cpu .; \
fi

# Ensure numpy 1.x is available (PyAnnote requires NumPy 1.x, not 2.x)
RUN uv pip install --system "numpy<2"

# Install PyTorch with CUDA 11.8 support for GTX 1070 (compute capability 6.1)
RUN uv pip install --system torch==2.2.0+cu118 torchaudio==2.2.0+cu118 --index-url https://download.pytorch.org/whl/cu118




# Create directories
RUN mkdir -p /app/audio_chunks /app/debug /app/data /models

# Set environment variables
ENV HF_HOME=/models
ENV PYTHONPATH=/app
ENV CUDA_VISIBLE_DEVICES=0
ENV TORCH_CUDA_ARCH_LIST="6.1"

# Expose port
EXPOSE 8085

# Run the service directly with python module
# CMD ["python", "-m", "simple_speaker_recognition.api.service"]
CMD ["uv", "run", "--no-dev", "--no-sync", "simple-speaker-service"] 